@using System.Text.Json
@using FKNI.Application.DTOs
@model FKNI.Application.DTOs.PromocionesDTO

@{
    ViewData["Title"] = "Create";
}

<style>
    ul.ui-autocomplete {
        z-index: 1100;
    }
</style>

<h1>Create</h1>

<h4>PromocionesDTO</h4>
<hr />
<div class="row">
    <div class="col-md-4">
        <form asp-action="Create" id="myForm"
              data-ajax="true"
              data-ajax-method="POST"
              data-ajax-begin="onBegin"
              data-ajax-failure="onFailure"
              data-ajax-success="onSuccess"
              data-ajax-complete="onComplete">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <div class="form-group">
                <label asp-for="TipoPromocion" class="control-label"></label>
                <input asp-for="TipoPromocion" class="form-control" />
                <span asp-validation-for="TipoPromocion" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label for="NombreProductoInput" class="control-label">Buscar producto</label>
                <input type="text" id="NombreProductoInput" class="form-control form-control-sm" placeholder="Escriba el nombre del producto" />
                <!-- Campo oculto que se enviará con el formulario -->
                <input type="hidden" asp-for="IdProducto" id="IdProducto" />
                <span asp-validation-for="IdProducto" class="text-danger"></span>
                <label id="NombreProducto" class="control-label fw-bold">-</label>
            </div>
            <div class="form-group">
                <label asp-for="IdCategoria" class="control-label"></label>
                <input asp-for="IdCategoria" class="form-control" />
                <span asp-validation-for="IdCategoria" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Descuento" class="control-label"></label>
                <input asp-for="Descuento" class="form-control" />
                <span asp-validation-for="Descuento" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="FechaInicio" class="control-label"></label>
                <input asp-for="FechaInicio" class="form-control" />
                <span asp-validation-for="FechaInicio" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="FechaFin" class="control-label"></label>
                <input asp-for="FechaFin" class="form-control" />
                <span asp-validation-for="FechaFin" class="text-danger"></span>
            </div>
            <div class="form-group">
                <input type="submit" value="Create" class="btn btn-primary" />
            </div>
        </form>
    </div>
</div>

<div>
    <a asp-action="Index">Back to List</a>
</div>

@section Scripts {
    <script>
        /**************************/
        // Busca el cliente por nombre+apellido1+apellido2 //
        /**************************/

        $("#IdProducto").autocomplete({
            source: function (request, response) {
                var IdProducto = $("#IdProducto").val();
                console.log(IdProducto);
                $.ajax({
                    type: "GET",
                    url: '@Url.Action("GetProductoByName", "Productos")',
                    dataType: "json",
                    data: { filtro: IdProducto },
                    success: function (data) {
                        response($.map(data, function (item) {
                            console.log(item);
                            return { label: item.nombreproducto + " ", value: item.idCliente };
                        }));
                    },
                    error: function (xhr, status, error) {
                        console.log(error)
                        alert("Error: " + error + ", No Error: " + xhr.status);
                    },
                });
            },
            select: function (event, ui) {

                $("#IdProducto").val(ui.item.value);
                $("#NombreProducto").html(ui.item.label)

                return false;
            }
        });


        /**************************/
        // Limpiar cajas de texto cuando tenga el foco
        /**************************/
        $("#IdProducto").focus(function () {
            // Limpia la caja de texto
            $("#IdProducto").val("");
            $("#NombreProducto").html("*")
        });
        //Controles de AJAX
        function onBegin() {
            console.log("onBegin")
        }

        function onFailure(response) {
            console.log("onFailure")
            Swal.fire({
                title: "Error!",
                text: response.responseText,
                icon: "error"
            });
        }

        function onSuccess(response) {
            console.log("onSuccess")
            document.getElementById("myForm").reset();
            document.getElementById("NombreProducto").innerHTML = ""
            

            Swal.fire({
                icon: "success",
                title: "Orden salvada ...",
                showConfirmButton: false,
                timer: 1500
            });
            location.reload();

        }

        function onComplete() {
            console.log("Fin del proceso")
        }
        function onClearForm() {
            document.getElementById("myForm").reset();
            document.getElementById("NombreProducto").innerHTML = ""
            

        }
    </script>

    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
